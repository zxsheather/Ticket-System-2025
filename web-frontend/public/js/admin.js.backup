/**
 * 管理员面板JavaScript
 * 处理管理员界面的交互和实时更新
 */

class AdminPanel {
  constructor() {
    this.socket = null;
    this.currentTab = 'dashboard';
    this.systemStatus = null;
    this.refreshInterval = null;
    this.charts = {};
    
    this.init();
  }

  /**
   * 初始化管理面板
   */
  init() {
    this.initializeSocket();
    this.setupEventListeners();
    this.setupCharts();
    this.startAutoRefresh();
    
    console.log('管理员面板已初始化');
  }

  /**
   * 初始化WebSocket连接
   */
  initializeSocket() {
    this.socket = io();
    
    // 连接成功
    this.socket.on('connect', () => {
      console.log('WebSocket连接成功');
      
      // 认证管理员身份
      const userData = {
        username: window.currentUser?.username,
        privilege: window.currentUser?.privilege || 0
      };
      
      this.socket.emit('user_auth', userData);
      this.socket.emit('join_room', 'admin');
    });

    // 认证成功
    this.socket.on('auth_success', (data) => {
      console.log('管理员认证成功:', data);
      this.updateConnectionStatus(true);
    });

    // 系统状态更新
    this.socket.on('system_status', (status) => {
      this.updateSystemStatus(status);
    });

    // 管理员通知
    this.socket.on('admin_notification', (notification) => {
      this.showNotification(notification);
    });

    // 管理员广播
    this.socket.on('admin_broadcast', (data) => {
      this.handleAdminBroadcast(data);
    });

    // 连接错误
    this.socket.on('connect_error', (error) => {
      console.error('WebSocket连接错误:', error);
      this.updateConnectionStatus(false);
    });

    // 断开连接
    this.socket.on('disconnect', () => {
      console.log('WebSocket连接断开');
      this.updateConnectionStatus(false);
    });
  }

  /**
   * 设置事件监听器
   */
  setupEventListeners() {
    // 表单提交处理
    this.setupFormHandlers();
    
    // 模态框处理
    this.setupModalHandlers();
    
    // 实时搜索
    this.setupSearchHandlers();
    
    // 批量操作
    this.setupBatchActions();
    
    // 添加列车表单中车站数量变化监听器
    this.setupTrainFormHandlers();
  }

  /**
   * 设置表单处理器
   */
  setupFormHandlers() {
    // 添加列车表单
    const addTrainForm = document.getElementById('addTrainForm');
    if (addTrainForm) {
      addTrainForm.addEventListener('submit', (e) => {
        e.preventDefault();
        this.handleAddTrain(e.target);
      });
    }

    // 广播消息表单
    const broadcastForm = document.getElementById('broadcastForm');
    if (broadcastForm) {
      broadcastForm.addEventListener('submit', (e) => {
        e.preventDefault();
        this.handleBroadcastMessage(e.target);
      });
    }

    // 用户管理表单
    const userManageForm = document.getElementById('userManageForm');
    if (userManageForm) {
      userManageForm.addEventListener('submit', (e) => {
        e.preventDefault();
        this.handleUserAction(e.target);
      });
    }
  }

  /**
   * 设置模态框处理器
   */
  setupModalHandlers() {
    // 删除确认模态框
    const deleteModal = document.getElementById('deleteModal');
    if (deleteModal) {
      const confirmBtn = deleteModal.querySelector('.btn-danger');
      if (confirmBtn) {
        confirmBtn.addEventListener('click', () => {
          this.executeDelete();
        });
      }
    }

    // 用户详情模态框
    const userDetailModal = document.getElementById('userDetailModal');
    if (userDetailModal) {
      userDetailModal.addEventListener('show.bs.modal', (e) => {
        const userId = e.relatedTarget.dataset.userId;
        this.loadUserDetails(userId);
      });
    }
  }

  /**
   * 设置搜索处理器
   */
  setupSearchHandlers() {
    // 用户搜索
    const userSearchInput = document.getElementById('userSearch');
    if (userSearchInput) {
      let searchTimeout;
      userSearchInput.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          this.searchUsers(e.target.value);
        }, 300);
      });
    }

    // 订单搜索
    const orderSearchInput = document.getElementById('orderSearch');
    if (orderSearchInput) {
      let searchTimeout;
      orderSearchInput.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          this.searchOrders(e.target.value);
        }, 300);
      });
    }
  }

  /**
   * 设置批量操作
   */
  setupBatchActions() {
    // 全选复选框
    const selectAllCheckbox = document.getElementById('selectAll');
    if (selectAllCheckbox) {
      selectAllCheckbox.addEventListener('change', (e) => {
        const checkboxes = document.querySelectorAll('.item-checkbox');
        checkboxes.forEach(cb => cb.checked = e.target.checked);
        this.updateBatchActions();
      });
    }

    // 批量操作按钮
    const batchDeleteBtn = document.getElementById('batchDelete');
    if (batchDeleteBtn) {
      batchDeleteBtn.addEventListener('click', () => {
        this.handleBatchDelete();
      });
    }
  }

  /**
   * 设置图表
   */
  setupCharts() {
    // 系统性能图表
    this.setupPerformanceChart();
    
    // 用户活动图表
    this.setupUserActivityChart();
    
    // 订单统计图表
    this.setupOrderChart();
  }

  /**
   * 设置性能图表
   */
  setupPerformanceChart() {
    const ctx = document.getElementById('performanceChart');
    if (!ctx) return;

    this.charts.performance = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'CPU使用率 (%)',
          data: [],
          borderColor: 'rgb(255, 99, 132)',
          backgroundColor: 'rgba(255, 99, 132, 0.2)',
          tension: 0.1
        }, {
          label: '内存使用率 (%)',
          data: [],
          borderColor: 'rgb(54, 162, 235)',
          backgroundColor: 'rgba(54, 162, 235, 0.2)',
          tension: 0.1
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            max: 100
          }
        },
        plugins: {
          title: {
            display: true,
            text: '系统性能监控'
          }
        }
      }
    });
  }

  /**
   * 设置用户活动图表
   */
  setupUserActivityChart() {
    const ctx = document.getElementById('userActivityChart');
    if (!ctx) return;

    this.charts.userActivity = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['登录', '注册', '购票', '查询', '退票'],
        datasets: [{
          label: '今日活动',
          data: [0, 0, 0, 0, 0],
          backgroundColor: [
            'rgba(255, 99, 132, 0.8)',
            'rgba(54, 162, 235, 0.8)',
            'rgba(255, 205, 86, 0.8)',
            'rgba(75, 192, 192, 0.8)',
            'rgba(153, 102, 255, 0.8)'
          ]
        }]
      },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: '用户活动统计'
          }
        }
      }
    });
  }

  /**
   * 设置订单图表
   */
  setupOrderChart() {
    const ctx = document.getElementById('orderChart');
    if (!ctx) return;

    this.charts.order = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['已支付', '待支付', '已取消', '已退票'],
        datasets: [{
          data: [0, 0, 0, 0],
          backgroundColor: [
            'rgba(75, 192, 192, 0.8)',
            'rgba(255, 205, 86, 0.8)',
            'rgba(255, 99, 132, 0.8)',
            'rgba(153, 102, 255, 0.8)'
          ]
        }]
      },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: '订单状态分布'
          }
        }
      }
    });
  }

  /**
   * 开始自动刷新
   */
  startAutoRefresh() {
    this.refreshInterval = setInterval(() => {
      if (this.currentTab === 'dashboard') {
        this.refreshDashboard();
      }
    }, 30000); // 30秒刷新一次
  }

  /**
   * 显示标签页
   */
  showTab(tabName) {
    // 隐藏所有标签页内容
    document.querySelectorAll('.tab-content').forEach(tab => {
      tab.style.display = 'none';
    });

    // 移除所有活动状态
    document.querySelectorAll('.list-group-item').forEach(item => {
      item.classList.remove('active');
    });

    // 显示目标标签页
    const targetTab = document.getElementById(tabName);
    if (targetTab) {
      targetTab.style.display = 'block';
    }

    // 设置活动状态
    const targetLink = document.querySelector(`[onclick="showTab('${tabName}')"]`);
    if (targetLink) {
      targetLink.classList.add('active');
    }

    this.currentTab = tabName;

    // 根据标签页执行特定操作
    switch (tabName) {
      case 'dashboard':
        this.refreshDashboard();
        break;
      case 'users':
        this.loadUsers();
        break;
      case 'orders':
        this.loadOrders();
        break;
      case 'trains':
        this.loadTrains();
        break;
      case 'logs':
        this.loadLogs();
        break;
    }
  }

  /**
   * 刷新仪表板
   */
  async refreshDashboard() {
    try {
      const response = await fetch('/api/system/status');
      if (response.ok) {
        const data = await response.json();
        if (data.success) {
          this.updateDashboard(data.data);
        }
      }
    } catch (error) {
      console.error('刷新仪表板失败:', error);
    }
  }

  /**
   * 更新仪表板
   */
  updateDashboard(data) {
    // 更新系统健康状态
    this.updateHealthCards(data.health);
    
    // 更新通知统计
    this.updateNotificationStats(data.notifications);
    
    // 更新图表数据
    this.updateCharts(data);
  }

  /**
   * 更新健康卡片
   */
  updateHealthCards(health) {
    const statusElement = document.getElementById('systemStatus');
    if (statusElement) {
      statusElement.textContent = health.status === 'healthy' ? '正常' : '警告';
      statusElement.className = `badge ${health.status === 'healthy' ? 'bg-success' : 'bg-warning'}`;
    }

    // 更新各项指标
    Object.entries(health.checks).forEach(([key, check]) => {
      const element = document.getElementById(`${key}Status`);
      if (element) {
        element.textContent = check.value;
        element.className = `badge ${check.status === 'healthy' ? 'bg-success' : 'bg-warning'}`;
      }
    });
  }

  /**
   * 更新通知统计
   */
  updateNotificationStats(stats) {
    const elements = {
      totalUsers: document.getElementById('totalUsers'),
      onlineUsers: document.getElementById('onlineUsers'),
      totalNotifications: document.getElementById('totalNotifications'),
      unreadNotifications: document.getElementById('unreadNotifications')
    };

    Object.entries(elements).forEach(([key, element]) => {
      if (element && stats[key] !== undefined) {
        element.textContent = stats[key];
      }
    });
  }

  /**
   * 更新系统状态
   */
  updateSystemStatus(status) {
    this.systemStatus = status;
    
    // 更新性能图表
    if (this.charts.performance && status.cpu && status.memory) {
      const chart = this.charts.performance;
      const time = new Date(status.timestamp).toLocaleTimeString();
      
      chart.data.labels.push(time);
      chart.data.datasets[0].data.push(status.cpu.usage);
      chart.data.datasets[1].data.push(parseFloat(status.memory.system.usagePercent));
      
      // 保持最多20个数据点
      if (chart.data.labels.length > 20) {
        chart.data.labels.shift();
        chart.data.datasets.forEach(dataset => {
          dataset.data.shift();
        });
      }
      
      chart.update('none');
    }
  }

  /**
   * 更新连接状态
   */
  updateConnectionStatus(connected) {
    const statusElement = document.getElementById('connectionStatus');
    if (statusElement) {
      statusElement.textContent = connected ? '已连接' : '已断开';
      statusElement.className = `badge ${connected ? 'bg-success' : 'bg-danger'}`;
    }
  }

  /**
   * 显示通知
   */
  showNotification(notification) {
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${this.getLevelClass(notification.level)} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">
          <strong>${notification.title}</strong><br>
          ${notification.message}
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    `;

    const toastContainer = document.getElementById('toastContainer') || document.body;
    toastContainer.appendChild(toast);

    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();

    // 自动移除
    toast.addEventListener('hidden.bs.toast', () => {
      toast.remove();
    });
  }

  /**
   * 获取级别对应的CSS类
   */
  getLevelClass(level) {
    const levelMap = {
      'success': 'success',
      'info': 'info',
      'warning': 'warning',
      'error': 'danger',
      'danger': 'danger'
    };
    return levelMap[level] || 'info';
  }

  /**
   * 处理添加列车
   */
  async handleAddTrain(form) {
    const formData = new FormData(form);
    const trainData = Object.fromEntries(formData.entries());

    try {
      const response = await fetch('/api/admin/trains', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(trainData)
      });

      const result = await response.json();
      
      if (result.success) {
        this.showNotification({
          title: '成功',
          message: '列车添加成功',
          level: 'success'
        });
        form.reset();
        this.loadTrains();
      } else {
        this.showNotification({
          title: '错误',
          message: result.message || '添加列车失败',
          level: 'error'
        });
      }
    } catch (error) {
      console.error('添加列车失败:', error);
      this.showNotification({
        title: '错误',
        message: '网络错误，请稍后重试',
        level: 'error'
      });
    }
  }

  /**
   * 处理广播消息
   */
  async handleBroadcastMessage(form) {
    const formData = new FormData(form);
    const message = formData.get('message');
    const level = formData.get('level') || 'info';

    if (!message.trim()) {
      this.showNotification({
        title: '错误',
        message: '消息内容不能为空',
        level: 'error'
      });
      return;
    }

    // 通过WebSocket发送广播
    this.socket.emit('admin_action', {
      action: 'broadcast_message',
      params: {
        message: message,
        level: level
      }
    });

    this.showNotification({
      title: '成功',
      message: '消息已广播',
      level: 'success'
    });

    form.reset();
  }

  /**
   * 加载用户列表
   */
  async loadUsers() {
    try {
      const response = await fetch('/api/admin/users');
      if (response.ok) {
        const data = await response.json();
        if (data.success) {
          this.renderUserTable(data.data);
        }
      }
    } catch (error) {
      console.error('加载用户列表失败:', error);
    }
  }

  /**
   * 渲染用户表格
   */
  renderUserTable(users) {
    const tbody = document.querySelector('#usersTable tbody');
    if (!tbody) return;

    tbody.innerHTML = users.map(user => `
      <tr>
        <td>
          <input type="checkbox" class="form-check-input item-checkbox" value="${user.username}">
        </td>
        <td>${user.username}</td>
        <td>${user.name || '-'}</td>
        <td>${user.mailAddr || '-'}</td>
        <td>
          <span class="badge ${user.privilege >= 10 ? 'bg-danger' : 'bg-primary'}">
            ${user.privilege >= 10 ? '管理员' : '普通用户'}
          </span>
        </td>
        <td>${new Date(user.createTime).toLocaleString()}</td>
        <td>
          <button class="btn btn-sm btn-outline-primary" onclick="adminPanel.viewUser('${user.username}')">
            <i class="fas fa-eye"></i>
          </button>
          <button class="btn btn-sm btn-outline-warning" onclick="adminPanel.editUser('${user.username}')">
            <i class="fas fa-edit"></i>
          </button>
          <button class="btn btn-sm btn-outline-danger" onclick="adminPanel.deleteUser('${user.username}')">
            <i class="fas fa-trash"></i>
          </button>
        </td>
      </tr>
    `).join('');
  }

  /**
   * 设置添加列车表单处理器
   */
  setupTrainFormHandlers() {
    const stationNumInput = document.getElementById('stationNum');
    if (stationNumInput) {
      stationNumInput.addEventListener('change', (e) => {
        this.generateStationInputs(parseInt(e.target.value));
      });
    }
  }

  /**
   * 动态生成车站输入框
   */
  generateStationInputs(stationCount) {
    const container = document.getElementById('stationsContainer');
    if (!container) return;

    // 清空现有内容
    container.innerHTML = '';

    if (stationCount < 2) return;

    // 生成车站信息标题
    const stationsTitle = document.createElement('h6');
    stationsTitle.className = 'mb-3 text-primary';
    stationsTitle.innerHTML = '<i class="fas fa-map-marker-alt me-2"></i>车站信息';
    container.appendChild(stationsTitle);

    // 生成车站输入框
    for (let i = 0; i < stationCount; i++) {
      const row = document.createElement('div');
      row.className = 'row mb-3';
      
      const stationCol = document.createElement('div');
      stationCol.className = 'col-md-4';
      stationCol.innerHTML = `
        <label class="form-label">第${i + 1}站</label>
        <input type="text" class="form-control station-input" 
               name="station_${i}" placeholder="车站名称" required>
      `;

      const priceCol = document.createElement('div');
      priceCol.className = 'col-md-2';
      if (i < stationCount - 1) {
        priceCol.innerHTML = `
          <label class="form-label">到下一站票价</label>
          <input type="number" class="form-control price-input" 
                 name="price_${i}" placeholder="票价" min="1" required>
        `;
      }

      const travelTimeCol = document.createElement('div');
      travelTimeCol.className = 'col-md-2';
      if (i < stationCount - 1) {
        travelTimeCol.innerHTML = `
          <label class="form-label">行驶时间(分钟)</label>
          <input type="number" class="form-control travel-time-input" 
                 name="travelTime_${i}" placeholder="分钟" min="1" required>
        `;
      }

      const stopoverCol = document.createElement('div');
      stopoverCol.className = 'col-md-2';
      if (i > 0 && i < stationCount - 1) {
        stopoverCol.innerHTML = `
          <label class="form-label">停靠时间(分钟)</label>
          <input type="number" class="form-control stopover-input" 
                 name="stopover_${i}" placeholder="分钟" min="0" value="0">
        `;
      }

      row.appendChild(stationCol);
      row.appendChild(priceCol);
      row.appendChild(travelTimeCol);
      row.appendChild(stopoverCol);
      container.appendChild(row);
    }
  }

  /**
   * 设置图表
   */
  setupCharts() {
    // 系统性能图表
    this.setupPerformanceChart();
    
    // 用户活动图表
    this.setupUserActivityChart();
    
    // 订单统计图表
    this.setupOrderChart();
  }

  /**
   * 设置性能图表
   */
  setupPerformanceChart() {
    const ctx = document.getElementById('performanceChart');
    if (!ctx) return;

    this.charts.performance = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'CPU使用率 (%)',
          data: [],
          borderColor: 'rgb(255, 99, 132)',
          backgroundColor: 'rgba(255, 99, 132, 0.2)',
          tension: 0.1
        }, {
          label: '内存使用率 (%)',
          data: [],
          borderColor: 'rgb(54, 162, 235)',
          backgroundColor: 'rgba(54, 162, 235, 0.2)',
          tension: 0.1
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            max: 100
          }
        },
        plugins: {
          title: {
            display: true,
            text: '系统性能监控'
          }
        }
      }
    });
  }

  /**
   * 设置用户活动图表
   */
  setupUserActivityChart() {
    const ctx = document.getElementById('userActivityChart');
    if (!ctx) return;

    this.charts.userActivity = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['登录', '注册', '购票', '查询', '退票'],
        datasets: [{
          label: '今日活动',
          data: [0, 0, 0, 0, 0],
          backgroundColor: [
            'rgba(255, 99, 132, 0.8)',
            'rgba(54, 162, 235, 0.8)',
            'rgba(255, 205, 86, 0.8)',
            'rgba(75, 192, 192, 0.8)',
            'rgba(153, 102, 255, 0.8)'
          ]
        }]
      },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: '用户活动统计'
          }
        }
      }
    });
  }

  /**
   * 设置订单图表
   */
  setupOrderChart() {
    const ctx = document.getElementById('orderChart');
    if (!ctx) return;

    this.charts.order = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['已支付', '待支付', '已取消', '已退票'],
        datasets: [{
          data: [0, 0, 0, 0],
          backgroundColor: [
            'rgba(75, 192, 192, 0.8)',
            'rgba(255, 205, 86, 0.8)',
            'rgba(255, 99, 132, 0.8)',
            'rgba(153, 102, 255, 0.8)'
          ]
        }]
      },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: '订单状态分布'
          }
        }
      }
    });
  }

  /**
   * 开始自动刷新
   */
  startAutoRefresh() {
    this.refreshInterval = setInterval(() => {
      if (this.currentTab === 'dashboard') {
        this.refreshDashboard();
      }
    }, 30000); // 30秒刷新一次
  }

  /**
   * 显示标签页
   */
  showTab(tabName) {
    // 隐藏所有标签页内容
    document.querySelectorAll('.tab-content').forEach(tab => {
      tab.style.display = 'none';
    });

    // 移除所有活动状态
    document.querySelectorAll('.list-group-item').forEach(item => {
      item.classList.remove('active');
    });

    // 显示目标标签页
    const targetTab = document.getElementById(tabName);
    if (targetTab) {
      targetTab.style.display = 'block';
    }

    // 设置活动状态
    const targetLink = document.querySelector(`[onclick="showTab('${tabName}')"]`);
    if (targetLink) {
      targetLink.classList.add('active');
    }

    this.currentTab = tabName;

    // 根据标签页执行特定操作
    switch (tabName) {
      case 'dashboard':
        this.refreshDashboard();
        break;
      case 'users':
        this.loadUsers();
        break;
      case 'orders':
        this.loadOrders();
        break;
      case 'trains':
        this.loadTrains();
        break;
      case 'logs':
        this.loadLogs();
        break;
    }
  }

  /**
   * 刷新仪表板
   */
  async refreshDashboard() {
    try {
      const response = await fetch('/api/system/status');
      if (response.ok) {
        const data = await response.json();
        if (data.success) {
          this.updateDashboard(data.data);
        }
      }
    } catch (error) {
      console.error('刷新仪表板失败:', error);
    }
  }

  /**
   * 更新仪表板
   */
  updateDashboard(data) {
    // 更新系统健康状态
    this.updateHealthCards(data.health);
    
    // 更新通知统计
    this.updateNotificationStats(data.notifications);
    
    // 更新图表数据
    this.updateCharts(data);
  }

  /**
   * 更新健康卡片
   */
  updateHealthCards(health) {
    const statusElement = document.getElementById('systemStatus');
    if (statusElement) {
      statusElement.textContent = health.status === 'healthy' ? '正常' : '警告';
      statusElement.className = `badge ${health.status === 'healthy' ? 'bg-success' : 'bg-warning'}`;
    }

    // 更新各项指标
    Object.entries(health.checks).forEach(([key, check]) => {
      const element = document.getElementById(`${key}Status`);
      if (element) {
        element.textContent = check.value;
        element.className = `badge ${check.status === 'healthy' ? 'bg-success' : 'bg-warning'}`;
      }
    });
  }

  /**
   * 更新通知统计
   */
  updateNotificationStats(stats) {
    const elements = {
      totalUsers: document.getElementById('totalUsers'),
      onlineUsers: document.getElementById('onlineUsers'),
      totalNotifications: document.getElementById('totalNotifications'),
      unreadNotifications: document.getElementById('unreadNotifications')
    };

    Object.entries(elements).forEach(([key, element]) => {
      if (element && stats[key] !== undefined) {
        element.textContent = stats[key];
      }
    });
  }

  /**
   * 更新系统状态
   */
  updateSystemStatus(status) {
    this.systemStatus = status;
    
    // 更新性能图表
    if (this.charts.performance && status.cpu && status.memory) {
      const chart = this.charts.performance;
      const time = new Date(status.timestamp).toLocaleTimeString();
      
      chart.data.labels.push(time);
      chart.data.datasets[0].data.push(status.cpu.usage);
      chart.data.datasets[1].data.push(parseFloat(status.memory.system.usagePercent));
      
      // 保持最多20个数据点
      if (chart.data.labels.length > 20) {
        chart.data.labels.shift();
        chart.data.datasets.forEach(dataset => {
          dataset.data.shift();
        });
      }
      
      chart.update('none');
    }
  }

  /**
   * 更新连接状态
   */
  updateConnectionStatus(connected) {
    const statusElement = document.getElementById('connectionStatus');
    if (statusElement) {
      statusElement.textContent = connected ? '已连接' : '已断开';
      statusElement.className = `badge ${connected ? 'bg-success' : 'bg-danger'}`;
    }
  }

  /**
   * 显示通知
   */
  showNotification(notification) {
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${this.getLevelClass(notification.level)} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">
          <strong>${notification.title}</strong><br>
          ${notification.message}
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    `;

    const toastContainer = document.getElementById('toastContainer') || document.body;
    toastContainer.appendChild(toast);

    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();

    // 自动移除
    toast.addEventListener('hidden.bs.toast', () => {
      toast.remove();
    });
  }

  /**
   * 获取级别对应的CSS类
   */
  getLevelClass(level) {
    const levelMap = {
      'success': 'success',
      'info': 'info',
      'warning': 'warning',
      'error': 'danger',
      'danger': 'danger'
    };
    return levelMap[level] || 'info';
  }

  /**
   * 处理添加列车
   */
  async handleAddTrain(form) {
    const formData = new FormData(form);
    const trainData = Object.fromEntries(formData.entries());

    try {
      const response = await fetch('/api/admin/trains', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(trainData)
      });

      const result = await response.json();
      
      if (result.success) {
        this.showNotification({
          title: '成功',
          message: '列车添加成功',
          level: 'success'
        });
        form.reset();
        this.loadTrains();
      } else {
        this.showNotification({
          title: '错误',
          message: result.message || '添加列车失败',
          level: 'error'
        });
      }
    } catch (error) {
      console.error('添加列车失败:', error);
      this.showNotification({
        title: '错误',
        message: '网络错误，请稍后重试',
        level: 'error'
      });
    }
  }

  /**
   * 处理广播消息
   */
  async handleBroadcastMessage(form) {
    const formData = new FormData(form);
    const message = formData.get('message');
    const level = formData.get('level') || 'info';

    if (!message.trim()) {
      this.showNotification({
        title: '错误',
        message: '消息内容不能为空',
        level: 'error'
      });
      return;
    }

    // 通过WebSocket发送广播
    this.socket.emit('admin_action', {
      action: 'broadcast_message',
      params: {
        message: message,
        level: level
      }
    });

    this.showNotification({
      title: '成功',
      message: '消息已广播',
      level: 'success'
    });

    form.reset();
  }

  /**
   * 加载用户列表
   */
  async loadUsers() {
    try {
      const response = await fetch('/api/admin/users');
      if (response.ok) {
        const data = await response.json();
        if (data.success) {
          this.renderUserTable(data.data);
        }
      }
    } catch (error) {
      console.error('加载用户列表失败:', error);
    }
  }

  /**
   * 渲染用户表格
   */
  renderUserTable(users) {
    const tbody = document.querySelector('#usersTable tbody');
    if (!tbody) return;

    tbody.innerHTML = users.map(user => `
      <tr>
        <td>
          <input type="checkbox" class="form-check-input item-checkbox" value="${user.username}">
        </td>
        <td>${user.username}</td>
        <td>${user.name || '-'}</td>
        <td>${user.mailAddr || '-'}</td>
        <td>
          <span class="badge ${user.privilege >= 10 ? 'bg-danger' : 'bg-primary'}">
            ${user.privilege >= 10 ? '管理员' : '普通用户'}
          </span>
        </td>
        <td>${new Date(user.createTime).toLocaleString()}</td>
        <td>
          <button class="btn btn-sm btn-outline-primary" onclick="adminPanel.viewUser('${user.username}')">
            <i class="fas fa-eye"></i>
          </button>
          <button class="btn btn-sm btn-outline-warning" onclick="adminPanel.editUser('${user.username}')">
            <i class="fas fa-edit"></i>
          </button>
          <button class="btn btn-sm btn-outline-danger" onclick="adminPanel.deleteUser('${user.username}')">
            <i class="fas fa-trash"></i>
          </button>
        </td>
      </tr>
    `).join('');
  }

  /**
   * 销毁对象
   */
  destroy() {
    if (this.refreshInterval) {
      clearInterval(this.refreshInterval);
    }
    
    if (this.socket) {
      this.socket.disconnect();
    }
    
    Object.values(this.charts).forEach(chart => {
      if (chart) {
        chart.destroy();
      }
    });
  }
}

// 全局函数
window.showTab = function(tabName) {
  if (window.adminPanel) {
    window.adminPanel.showTab(tabName);
  }
};

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', () => {
  // 检查是否在管理员页面
  if (document.getElementById('adminPanel')) {
    window.adminPanel = new AdminPanel();
  }
});

// 页面卸载时清理
window.addEventListener('beforeunload', () => {
  if (window.adminPanel) {
    window.adminPanel.destroy();
  }
});
